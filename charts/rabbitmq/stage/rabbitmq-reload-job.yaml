---
# Job to reload definitions via Management API
apiVersion: batch/v1
kind: Job
metadata:
  name: rabbitmq-reload-definitions
  namespace: rabbitmq
  annotations:
    # ArgoCD will run this job after syncing
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300  # Clean up after 5 minutes
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: reload-definitions
          image: curlimages/curl:latest
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for RabbitMQ to be ready..."
              
              # Wait for RabbitMQ to be ready
              until curl -f -u $RABBITMQ_USER:$RABBITMQ_PASS http://rabbitmq:15672/api/overview 2>/dev/null; do
                echo "Waiting for RabbitMQ Management API..."
                sleep 5
              done
              
              echo "RabbitMQ is ready. Loading definitions..."
              
              # Load definitions from ConfigMap
              curl -u $RABBITMQ_USER:$RABBITMQ_PASS \
                -X POST \
                -H "Content-Type: application/json" \
                -d @/definitions/definitions.json \
                http://rabbitmq:15672/api/definitions
              
              if [ $? -eq 0 ]; then
                echo "✓ Definitions loaded successfully!"
              else
                echo "✗ Failed to load definitions"
                exit 1
              fi
          env:
            - name: RABBITMQ_USER
              valueFrom:
                secretKeyRef:
                  name: rabbitmq-credentials
                  key: username
            - name: RABBITMQ_PASS
              valueFrom:
                secretKeyRef:
                  name: rabbitmq-credentials
                  key: password
          volumeMounts:
            - name: definitions
              mountPath: /definitions
      volumes:
        - name: definitions
          configMap:
            name: rabbitmq-definitions