---
# Add this ConfigMap at the top or bottom of your rabbitmq-cluster.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: rabbitmq-definitions
  namespace: rabbitmq
data:
  definitions.json: |
    {
      "rabbit_version": "4.1.3",
      "rabbitmq_version": "4.1.3",
      "users": [
        {
          "name": "admin",
          "password_hash": "JBbKFh8rsyXWHMHkVnXLHPPsnp+VH+vhUdGi7FHZI+XTjVLQ",
          "hashing_algorithm": "rabbit_password_hashing_sha256",
          "tags": ["administrator"]
        },
        {
          "name": "app-user",
          "password_hash": "JBbKFh8rsyXWHMHkVnXLHPPsnp+VH+vhUdGi7FHZI+XTjVLQ",
          "hashing_algorithm": "rabbit_password_hashing_sha256",
          "tags": ["management"]
        }
      ],
      "vhosts": [
        {
          "name": "/"
        },
        {
          "name": "/production"
        }
      ],
      "permissions": [
        {
          "user": "admin",
          "vhost": "/",
          "configure": ".*",
          "write": ".*",
          "read": ".*"
        },
        {
          "user": "app-user",
          "vhost": "/",
          "configure": ".*",
          "write": ".*",
          "read": ".*"
        },
        {
          "user": "app-user",
          "vhost": "/production",
          "configure": ".*",
          "write": ".*",
          "read": ".*"
        }
      ],
      "topic_permissions": [],
      "parameters": [],
      "global_parameters": [
        {
          "name": "cluster_name",
          "value": "rabbitmq-stage"
        }
      ],
      "policies": [
        {
          "vhost": "/",
          "name": "ha-all",
          "pattern": ".*",
          "apply-to": "all",
          "definition": {
            "ha-mode": "all",
            "ha-sync-mode": "automatic"
          },
          "priority": 0
        },
        {
          "vhost": "/",
          "name": "ttl-policy",
          "pattern": "^ttl\\.",
          "apply-to": "queues",
          "definition": {
            "message-ttl": 3600000,
            "expires": 7200000
          },
          "priority": 1
        },
        {
          "vhost": "/production",
          "name": "ha-production",
          "pattern": ".*",
          "apply-to": "all",
          "definition": {
            "ha-mode": "exactly",
            "ha-params": 2,
            "ha-sync-mode": "automatic"
          },
          "priority": 0
        }
      ],
      "exchanges": [
        {
          "name": "events",
          "vhost": "/",
          "type": "topic",
          "durable": true,
          "auto_delete": false,
          "internal": false,
          "arguments": {}
        },
        {
          "name": "commands",
          "vhost": "/",
          "type": "direct",
          "durable": true,
          "auto_delete": false,
          "internal": false,
          "arguments": {}
        },
        {
          "name": "notifications",
          "vhost": "/",
          "type": "fanout",
          "durable": true,
          "auto_delete": false,
          "internal": false,
          "arguments": {}
        },
        {
          "name": "tasks",
          "vhost": "/",
          "type": "topic",
          "durable": true,
          "auto_delete": false,
          "internal": false,
          "arguments": {
            "alternate-exchange": "tasks.dlx"
          }
        },
        {
          "name": "tasks.dlx",
          "vhost": "/",
          "type": "direct",
          "durable": true,
          "auto_delete": false,
          "internal": false,
          "arguments": {}
        },
        {
          "name": "delayed-exchange",
          "vhost": "/",
          "type": "x-delayed-message",
          "durable": true,
          "auto_delete": false,
          "internal": false,
          "arguments": {
            "x-delayed-type": "direct"
          }
        },
        {
          "name": "prod.events",
          "vhost": "/production",
          "type": "topic",
          "durable": true,
          "auto_delete": false,
          "internal": false,
          "arguments": {}
        }
      ],
      "queues": [
        {
          "name": "user.created",
          "vhost": "/",
          "durable": true,
          "auto_delete": false,
          "arguments": {}
        },
        {
          "name": "user.updated",
          "vhost": "/",
          "durable": true,
          "auto_delete": false,
          "arguments": {}
        },
        {
          "name": "order.processing",
          "vhost": "/",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-message-ttl": 3600000,
            "x-max-length": 10000,
            "x-overflow": "reject-publish"
          }
        },
        {
          "name": "email.queue",
          "vhost": "/",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-max-priority": 10
          }
        },
        {
          "name": "tasks.processing",
          "vhost": "/",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-dead-letter-exchange": "tasks.dlx",
            "x-dead-letter-routing-key": "failed"
          }
        },
        {
          "name": "tasks.dlq",
          "vhost": "/",
          "durable": true,
          "auto_delete": false,
          "arguments": {}
        },
        {
          "name": "notification.all",
          "vhost": "/",
          "durable": true,
          "auto_delete": false,
          "arguments": {}
        },
        {
          "name": "ttl.example",
          "vhost": "/",
          "durable": true,
          "auto_delete": false,
          "arguments": {}
        },
        {
          "name": "prod.critical.events",
          "vhost": "/production",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-max-priority": 10
          }
        }
      ],
      "bindings": [
        {
          "source": "events",
          "vhost": "/",
          "destination": "user.created",
          "destination_type": "queue",
          "routing_key": "user.created",
          "arguments": {}
        },
        {
          "source": "events",
          "vhost": "/",
          "destination": "user.updated",
          "destination_type": "queue",
          "routing_key": "user.updated",
          "arguments": {}
        },
        {
          "source": "events",
          "vhost": "/",
          "destination": "user.updated",
          "destination_type": "queue",
          "routing_key": "user.*",
          "arguments": {}
        },
        {
          "source": "commands",
          "vhost": "/",
          "destination": "order.processing",
          "destination_type": "queue",
          "routing_key": "order.process",
          "arguments": {}
        },
        {
          "source": "commands",
          "vhost": "/",
          "destination": "email.queue",
          "destination_type": "queue",
          "routing_key": "email.send",
          "arguments": {}
        },
        {
          "source": "notifications",
          "vhost": "/",
          "destination": "notification.all",
          "destination_type": "queue",
          "routing_key": "",
          "arguments": {}
        },
        {
          "source": "tasks",
          "vhost": "/",
          "destination": "tasks.processing",
          "destination_type": "queue",
          "routing_key": "task.#",
          "arguments": {}
        },
        {
          "source": "tasks.dlx",
          "vhost": "/",
          "destination": "tasks.dlq",
          "destination_type": "queue",
          "routing_key": "failed",
          "arguments": {}
        },
        {
          "source": "prod.events",
          "vhost": "/production",
          "destination": "prod.critical.events",
          "destination_type": "queue",
          "routing_key": "critical.#",
          "arguments": {}
        }
      ]
    }
---

apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmq
  namespace: rabbitmq
  labels:
    app.kubernetes.io/name: rabbitmq
    app.kubernetes.io/component: messaging
    environment: stage

spec:
  replicas: 1  # 2 replicas for stage (balance between HA testing and resources)
  
  image: rabbitmq:4.1.3-management
  
  resources:
    requests:
      cpu: 1  # Use millicores format to match Kubernetes normalization
      memory: 2Gi
    limits:
      cpu: 2  # Use millicores format to match Kubernetes normalization
      memory: 4Gi
      
  persistence:
    storage: 5Gi
    storageClassName: testing
  
  rabbitmq:
    additionalConfig: |
      # Staging environment configuration
      # Note: cluster_formation.* and cluster_partition_handling are set by operator defaults

      # Memory and disk limits (overriding defaults for staging)
      vm_memory_high_watermark.relative = 0.6
      disk_free_limit.absolute = 1GB
      
      # Consumer timeout (15 minutes)
      consumer_timeout = 900000
      
      # Prometheus metrics (detailed)
      prometheus.return_per_object_metrics = true
      
      # High availability (overriding operator default)
      queue_master_locator = min-masters
      
      # Clustering (prod-like tuning)
      cluster_keepalive_interval = 10000
    
    additionalPlugins:
      # Note: rabbitmq_management, rabbitmq_prometheus, rabbitmq_peer_discovery_k8s are essential plugins (always enabled)
      - rabbitmq_shovel
      - rabbitmq_shovel_management
      - rabbitmq_federation
      - rabbitmq_federation_management
  
  service:
    type: ClusterIP
  
  override:
    statefulSet:
      spec:
        template:
          spec:
            containers:
              - name: rabbitmq
                env:
                  - name: RABBITMQ_DEFAULT_USER
                    value: guest
                  - name: RABBITMQ_DEFAULT_PASS
                    value: guest
  
  # High availability - spread across nodes
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - rabbitmq
          topologyKey: kubernetes.io/hostname
  
  # Toleration for dedicated nodes (if needed)
  # tolerations:
  #   - key: "workload"
  #     operator: "Equal"
  #     value: "rabbitmq"
  #     effect: "NoSchedule"
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: rabbitmq
  namespace: rabbitmq
spec:
  minAvailable: 1  # For 2 replicas: allow 1 to be disrupted, keep minimum 1 running
  selector:
    matchLabels:
      app.kubernetes.io/name: rabbitmq
